# Enhanced Semgrep Configuration for Node.js Security Scanning
# Custom rules specifically tailored for GitHub Actions integration

rules:
  # Node.js Security Rules
  - id: nodejs-insecure-eval
    patterns:
      - pattern: eval($INPUT)
    message: "Use of eval() is dangerous and can lead to code injection"
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
      owasp: 'A03:2021 – Injection'

  - id: nodejs-hardcoded-secret
    patterns:
      - pattern-either:
          - pattern: |
              $SECRET = "..."
          - pattern: |
              $API_KEY = "..."
          - pattern: |
              $PASSWORD = "..."
          - pattern: |
              $TOKEN = "..."
          - pattern: |
              process.env.$VAR = "..."
    message: "Hardcoded secret detected"
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-798: Use of Hard-coded Credentials'
      owasp: 'A07:2021 – Identification and Authentication Failures'

  - id: nodejs-sql-injection
    patterns:
      - pattern-either:
          - pattern: |
              db.query($QUERY + $INPUT)
          - pattern: |
              db.query("... " + $INPUT)
          - pattern: |
              db.query(\`... \$\{...}...\`)
    message: "Potential SQL injection vulnerability"
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-89: SQL Injection'
      owasp: 'A03:2021 – Injection'

  - id: nodejs-path-traversal
    patterns:
      - pattern: |
          fs.readFile($INPUT + $FILENAME)
      - pattern: |
          fs.readFileSync($INPUT + $FILENAME)
    message: "Potential path traversal vulnerability"
    severity: ERROR
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-22: Path Traversal'
      owasp: 'A01:2021 – Broken Access Control'

  - id: nodejs-xss
    patterns:
      - pattern-either:
          - pattern: |
              res.send($USER_INPUT)
          - pattern: |
              res.write($USER_INPUT)
          - pattern: |
              res.end($USER_INPUT)
    message: "Potential XSS vulnerability - user input should be sanitized"
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-79: Cross-site Scripting'
      owasp: 'A03:2021 – Injection'

  - id: nodejs-weak-crypto
    patterns:
      - pattern-either:
          - pattern: |
              crypto.createHash('md5')
          - pattern: |
              crypto.createHash('sha1')
          - pattern: |
              crypto.createHash('md4')
    message: "Weak cryptographic algorithm detected"
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-327: Use of a Broken or Risky Cryptographic Algorithm'
      owasp: 'A02:2021 – Cryptographic Failures'

  - id: nodejs-insecure-random
    patterns:
      - pattern: |
          Math.random()
    message: "Use of Math.random() for security-sensitive operations"
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-338: Use of Cryptographically Weak Random Number Generator'
      owasp: 'A02:2021 – Cryptographic Failures'

  - id: nodejs-debug-enabled
    patterns:
      - pattern-either:
          - pattern: |
              process.env.NODE_ENV === 'development'
          - pattern: |
              process.env.NODE_ENV !== 'production'
    message: "Debug mode may be enabled in production"
    severity: INFO
    languages: [javascript]
    metadata:
      category: security

  - id: nodejs-cors-misconfigured
    patterns:
      - pattern: |
          cors({ origin: true })
      - pattern: |
          cors({ origin: '*' })
    message: "CORS configured to allow all origins"
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      owasp: 'A05:2021 – Security Misconfiguration'

  - id: nodejs-insecure-deserialization
    patterns:
      - pattern: |
          JSON.parse($USER_INPUT)
    message: "Potential insecure deserialization of user input"
    severity: WARNING
    languages: [javascript]
    metadata:
      category: security
      cwe: 'CWE-502: Deserialization of Untrusted Data'
      owasp: 'A08:2021 – Software and Data Integrity Failures'

# Include standard Node.js rules
include:
  - p/nodejs
  - p/express
  - p/javascript
  - p/security
  - p/owasp-top-ten
  - p/cwe-top-25
  - p/r2c-security-audit
  - p/xss
  - p/sql-injection
  - p/command-injection
  - p/secrets
  - p/trailofbits
  - p/npm-audit

# Exclude patterns to reduce noise
exclude:
  - node_modules/
  - dist/
  - build/
  - coverage/
  - .git/
  - "*.min.js"
  - "*.test.js"
  - "*.spec.js"

# Semgrep settings
settings:
  interfile: true
  strict: true
  severity: INFO