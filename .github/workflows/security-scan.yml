name: ðŸ” PR Security Scan

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  security-events: write
  actions: read
  pull-requests: write

jobs:
  # ===========================================
  # STATIC APPLICATION SECURITY TESTING (SAST)
  # ===========================================
  sast-matrix:
    name: SAST Scanning
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scanner: [gitleaks, semgrep, njsscan, codeql]
        include:
          - scanner: gitleaks
            name: "Secret Detection"
            severity: "high"
          - scanner: semgrep
            name: "Static Analysis"
            severity: "medium"
          - scanner: njsscan
            name: "Node.js Security"
            severity: "medium"
          - scanner: codeql
            name: "Advanced Analysis"
            severity: "high"
      max-parallel: 2

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        if: matrix.scanner == 'njsscan'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Gitleaks Secret Scanning
        if: matrix.scanner == 'gitleaks'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          scan_path: .
          config_path: .github/gitleaks.toml
          format: sarif
          output_file: gitleaks.sarif

      - name: Semgrep SAST Scan
        if: matrix.scanner == 'semgrep'
        uses: semgrep/semgrep-action@v1
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        with:
          config: >-
            p/security
            p/owasp-top-ten
            p/nodejs
            p/javascript
            p/cwe-top-25
            p/trailofbits
          audit: 'on'
          generate-sarif: 'true'
          output: semgrep.sarif

      - name: NodeJS Security Scan
        if: matrix.scanner == 'njsscan'
        run: |
          npm ci --prefer-offline --no-audit
          pip install njsscan
          njsscan . --sarif -o njsscan.sarif || true

      - name: Initialize CodeQL
        if: matrix.scanner == 'codeql'
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: +security-and-quality

      - name: Autobuild for CodeQL
        if: matrix.scanner == 'codeql'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        if: matrix.scanner == 'codeql'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      - name: Upload SARIF Files
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ matrix.scanner }}.sarif
          category: ${{ matrix.name }}

  # ===========================================
  # DEPENDENCY SCANNING
  # ===========================================
  dependency-scan:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    needs: sast-matrix
    strategy:
      matrix:
        scanner: [npm-audit, snyk, dependabot, grype]
        include:
          - scanner: npm-audit
            name: "NPM Security Audit"
          - scanner: snyk
            name: "Snyk Vulnerability Scan"
          - scanner: dependabot
            name: "Dependency Review"
          - scanner: grype
            name: "Container Dependency Scan"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.scanner != 'grype'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore NPM Cache
        if: matrix.scanner != 'grype'
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        if: matrix.scanner != 'grype'
        run: npm ci --prefer-offline --no-audit

      - name: NPM Audit
        if: matrix.scanner == 'npm-audit'
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --audit-level=high

      - name: Snyk Security Scan
        if: matrix.scanner == 'snyk'
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk.sarif

      - name: Dependency Review
        if: matrix.scanner == 'dependabot'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-ghsas: |
            GHSA-xxxx-xxxx-xxxx
          deny-licenses: |
            GPL-2.0
            GPL-3.0

      - name: Build Container for Grype
        if: matrix.scanner == 'grype'
        run: |
          docker build -t temp-image .

      - name: Grype Vulnerability Scan
        if: matrix.scanner == 'grype'
        uses: anchore/scan-action@v3
        with:
          image: temp-image
          output-format: sarif
          sarif-file: grype.sarif

      - name: Upload Dependency Scan Results
        if: always() && matrix.scanner != 'npm-audit'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ matrix.scanner }}.sarif
          category: ${{ matrix.name }}

  # ===========================================
  # CONTAINER SECURITY SCANNING
  # ===========================================
  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    needs: dependency-scan
    outputs:
      trivy-scan-result: ${{ steps.trivy.outputs.exit-code }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and Push Container
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Run Trivy Vulnerability Scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Scan Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: container-security

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  # ===========================================
  # INFRASTRUCTURE SECURITY SCANNING
  # ===========================================
  infrastructure-security:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    needs: container-security

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Terraform Security Scan (tfsec)
        if: hashFiles('**/*.tf') != ''
        uses: aquasecurity/tfsec-action@master
        with:
          sarif_file: tfsec.sarif
          additional_args: --exclude-downloaded-modules

      - name: Kubernetes Security Scan (kube-score)
        if: hashFiles('**/*.yaml', '**/*.yml') != ''
        uses: kube-score/action@v1
        with:
          files: "**/*.yaml,**/*.yml"
          output-file: kube-score-results.txt

      - name: CloudFormation Security Scan (cfn-nag)
        if: hashFiles('**/*.yaml', '**/*.yml') != ''
        run: |
          gem install cfn-nag
          cfn_nag_scan --input-path . --output-format json --output-file cfn-nag-results.json || true

      - name: Upload Infrastructure Scan Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec.sarif
          category: infrastructure-security

  # ===========================================
  # SECURITY POLICY ENFORCEMENT
  # ===========================================
  security-policy-check:
    name: Security Policy Enforcement
    runs-on: ubuntu-latest
    needs: [sast-matrix, dependency-scan, container-security, infrastructure-security]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true

      - name: Security Policy Validation
        id: policy
        run: |
          # Create comprehensive security summary
          cat > security-summary.md << 'EOF'
          # Security Scan Summary

          ## Executive Dashboard
          - **Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Repository**: ${{ github.repository }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}

          ## Scan Results

          ### SAST Findings
          - Gitleaks: $(jq -r '.results | length' gitleaks.sarif 2>/dev/null || echo "0") secrets found
          - Semgrep: $(jq -r '.results | length' semgrep.sarif 2>/dev/null || echo "0") issues found
          - NodeJSScan: $(jq -r '.results | length' njsscan.sarif 2>/dev/null || echo "0") vulnerabilities found

          ### Dependency Findings
          - NPM Audit: $(jq -r '.vulnerabilities | length' npm-audit.json 2>/dev/null || echo "0") vulnerabilities
          - Snyk: $(jq -r '.runs[0].results | length' snyk.sarif 2>/dev/null || echo "0") issues found

          ### Container Findings
          - Trivy: $(jq -r '.runs[0].results | length' trivy-results.sarif 2>/dev/null || echo "0") vulnerabilities

          ### Infrastructure Findings
          - Terraform: $(jq -r '.results | length' tfsec.sarif 2>/dev/null || echo "0") issues
          - Kubernetes: Check kube-score-results.txt
          EOF

      - name: Comment PR with Security Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Security Gate Enforcement
        run: |
          # Define security thresholds
          MAX_CRITICAL_VULNS=0
          MAX_HIGH_VULNS=5
          MAX_MEDIUM_VULNS=20

          # Count critical and high vulnerabilities
          CRITICAL_COUNT=$(jq -r '[.runs[].results[] | select(.level == "error")] | length' trivy-results.sarif 2>/dev/null || echo "0")
          HIGH_COUNT=$(jq -r '[.runs[].results[] | select(.level == "warning")] | length' trivy-results.sarif 2>/dev/null || echo "0")

          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"

          # Security gate enforcement
          if [ "$CRITICAL_COUNT" -gt "$MAX_CRITICAL_VULNS" ]; then
            echo "âŒ SECURITY GATE FAILED: Critical vulnerabilities exceed threshold ($CRITICAL_COUNT > $MAX_CRITICAL_VULNS)"
            exit 1
          fi

          if [ "$HIGH_COUNT" -gt "$MAX_HIGH_VULNS" ]; then
            echo "âš ï¸ SECURITY WARNING: High vulnerabilities exceed threshold ($HIGH_COUNT > $MAX_HIGH_VULNS)"
            # Continue with warning
          fi

          echo "âœ… Security gates passed"

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 30

  # ===========================================
  # NOTIFICATIONS AND REPORTING
  # ===========================================
  notify-results:
    name: Security Scan Notifications
    runs-on: ubuntu-latest
    needs: [security-policy-check]
    if: always()

    steps:
      - name: Download Security Summary
        uses: actions/download-artifact@v4
        with:
          name: security-summary
          path: ./

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Security scanning completed for ${{ github.repository }}
            ðŸ“Š View results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ðŸ“‹ Security Summary attached
          channel: ${{ secrets.SLACK_SECURITY_CHANNEL }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Microsoft Teams Notification
        if: always()
        uses: jdcargile/ms-teams-notification@v1.3
        with:
          webhook-url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "Security Scan Results"
          summary: "Security scanning completed for ${{ github.repository }}"
          text: |
            **Repository**: ${{ github.repository }}
            **Status**: ${{ job.status }}
            **Run ID**: ${{ github.run_id }}
            **View Results**: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Send Email Report
        if: failure() || needs.security-policy-check.result == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ Security Scan Failed - ${{ github.repository }}"
          body: file://security-summary.md
          to: ${{ secrets.SECURITY_TEAM_EMAIL }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>